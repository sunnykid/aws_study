## Table of Contents
- [Table of Contents](#table-of-contents)
- [GitHub Repository ìƒì„±](#github-repository-ìƒì„±)
  - [1. GitHub, CodeDeployì— ì ìš©í•  IAM User \& Role ìƒì„±](#1-github-codedeployì—-ì ìš©í• -iam-user--role-ìƒì„±)
    - [1.1 GitHubìš© IAM User ìƒì„±](#11-githubìš©-iam-user-ìƒì„±)
    - [1.2 GitHubìš© Access Key / Secret key ìƒì„±](#12-githubìš©-access-key--secret-key-ìƒì„±)
    - [1.3 CodeDeployìš© IAM Role ìƒì„±](#13-codedeployìš©-iam-role-ìƒì„±)
  - [2. ê°œì¸ìš© GtiHub ê³„ì •ì— Repository ìƒì„±](#2-ê°œì¸ìš©-gtihub-ê³„ì •ì—-repository-ìƒì„±)
  - [3. VS Code IDE ì„œë²„ Local Repositoryì™€ GitHub Repository ì—°ë™](#3-vs-code-ide-ì„œë²„-local-repositoryì™€-github-repository-ì—°ë™)
  - [4. GitHub Repository ì„¤ì •](#4-github-repository-ì„¤ì •)
    - [4.1 Access Key ë“±ë¡](#41-access-key-ë“±ë¡)
- [CodeDeploy ìƒì„±](#codedeploy-ìƒì„±)
  - [1. CodeDeploy Application ìƒì„±](#1-codedeploy-application-ìƒì„±)
- [CodeDeploy Agent ì„¤ì •](#codedeploy-agent-ì„¤ì •)
  - [1. CodeDeploy Agent ì„¤ì¹˜](#1-codedeploy-agent-ì„¤ì¹˜)
- [GitHub Actions ì„¤ì •](#github-actions-ì„¤ì •)
  - [1. GitHub Actions ì½”ë“œ êµ¬ì„±](#1-github-actions-ì½”ë“œ-êµ¬ì„±)
  - [2. GitHub Actions YAML Code](#2-github-actions-yaml-code)

## GitHub Repository ìƒì„±

### 1. GitHub, CodeDeployì— ì ìš©í•  IAM User & Role ìƒì„±

#### 1.1 GitHubìš© IAM User ìƒì„±

- VS Code Terminal ì ‘ì† â†’ Project ë””ë ‰í† ë¦¬ ì´ë™

  ```bash
  cd /Workshop
  ```

- IAM User ìƒì„± ëª…ë ¹ì–´ ì‹¤í–‰

  ```bash
  aws iam create-user --user-name lab-edu-user-github
  ```

- IAM Userì— ì •ì±… í• ë‹¹ ëª…ë ¹ì–´ ì‹¤í–‰

  ```bash
  aws iam attach-user-policy --user-name lab-edu-user-github --policy-arn arn:aws:iam::aws:policy/AWSCodeDeployFullAccess
  ```

- í• ë‹¹ ëœ ì •ì±… í™•ì¸ ëª…ë ¹ì–´

  ```bash
  aws iam list-attached-user-policies --user-name lab-edu-user-github
  ```

#### 1.2 GitHubìš© Access Key / Secret key ìƒì„±

- Acces Key, Secret Key ìƒì„± ëª…ë ¹

  ```bash
  aws iam create-access-key --user-name lab-edu-user-github > ~/.ssh/access_key.json
  ```

- ìƒì„±ëœ Access / Secret Key ì •ë³´ í™•ì¸ (FILE_PATH: `~/.ssh/access_key.json`)

  ![alt text](./img/iam_user_access_secret_key.png)

#### 1.3 CodeDeployìš© IAM Role ìƒì„±

- VS Code Terminal ì ‘ì† â†’ Project ë””ë ‰í† ë¦¬ ì´ë™

  ```bash
  cd /Workshop
  ```

- IAM Role ìƒì„± ëª…ë ¹ì–´ ì‹¤í–‰

  ```bash
  aws iam create-role --role-name lab-edu-role-codedeploy --assume-role-policy-document file://support_files/policy/codedeploy_trust_policy.json
  ```

- IAM Roleì— ì •ì±… í• ë‹¹ ëª…ë ¹ì–´ ì‹¤í–‰

  ```bash
  aws iam attach-role-policy --role-name lab-edu-role-codedeploy --policy-arn arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole
  ```

- í• ë‹¹ ëœ ì •ì±… í™•ì¸ ëª…ë ¹ì–´

  ```bash
  aws iam list-attached-role-policies --role-name lab-edu-role-codedeploy
  ```

### 2. ê°œì¸ìš© GtiHub ê³„ì •ì— Repository ìƒì„±

- ê°œì¸ GitHub ê³„ì • ë¡œê·¸ì¸ â†’ `Repositories` íƒ­ â†’ `New` ë²„íŠ¼ í´ë¦­

  ![alt text](./img/create_github_01.png)

- Repository name: `cloud-wave` ì…ë ¥ â†’ `Create repository` ë²„íŠ¼ í´ë¦­

  ![alt text](./img/create_github_02.png)

### 3. VS Code IDE ì„œë²„ Local Repositoryì™€ GitHub Repository ì—°ë™

- VS Code IDE Terminal í™”ë©´ ì´ë™
 
- Git Local ì €ì¥ì†Œ ì´ˆê¸°í™”

  ```bash
  git init
  git branch -M main
  ```

- Remote Repository(GitHub) ë“±ë¡

  ```bash
  git remote add origin https://github.com/seunghyun-you/cloud-wave.git
  ```

- Source Code ë°°í¬

  ```bash
  git add .
  git commit -m "first commit"
  git push -u origin main
  ```

### 4. GitHub Repository ì„¤ì •

#### 4.1 Access Key ë“±ë¡

- ê°œì¸ GitHub Repository ì ‘ì† â†’ `Settings` íƒ­ â†’ `Secrets and variables` ì„ íƒ â†’ `Actions` ì„ íƒ â†’ `New repository secret` ë²„íŠ¼ í´ë¦­

  ![alt text](./img/access_key_01.png)

- Access key ì •ë³´ ì…ë ¥ â†’ `Add secret` ë²„íŠ¼ í´ë¦­

  - Name: AWS_ACCESS_KEY

  - Secret: [AWS_ACCESS_KEY_VALUE]

    > `~/.ssh/access_key.json` íŒŒì¼ì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê¸°

    ![alt text](./img/access_key_02.png)

- Sccess key ì •ë³´ ì…ë ¥ â†’ `Add secret` ë²„íŠ¼ í´ë¦­

  - Name: AWS_SECRET_KEY

  - Secret: [AWS_SECRET_KEY_VALUE]

<br>




## CodeDeploy ìƒì„±

### 1. CodeDeploy Application ìƒì„±

- **CodeDeploy ì½˜ì†” ë©”ì¸ í™”ë©´ â†’ `ì• í”Œë¦¬ì¼€ì´ì…˜` íƒ­ â†’ `ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„±` ë²„íŠ¼ í´ë¦­**

  ![alt text](./img/code_deploy_app_01.png)

- Application ìƒì„± ì •ë³´ ì…ë ¥

  - ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„: lab-edu-cd-application-streamlit

  - ì»´í“¨íŒ… í”Œë«í¼: EC2/ì˜¨í”„ë ˆë¯¸ìŠ¤

    ![alt text](./img/code_deploy_app_02.png)

- `ë°°í¬ ê·¸ë£¹ ìƒì„±` ë²„íŠ¼ í´ë¦­

  ![alt text](./img/code_deploy_app_03.png)

- ë°°í¬ ê·¸ë£¹ ìƒì„± ì •ë³´ ì…ë ¥

  - ë°°í¬ ê·¸ë£¹ ì´ë¦„: lab-edu-cd-deploygroup

  - ì„œë¹„ìŠ¤ ì—­í• : lab-edu-role-codedeploy

    ![alt text](./img/code_deploy_deploy_group_01.png)

  - `Amazon EC2 ì¸ìŠ¤í„´ìŠ¤` ì²´í¬

  - í‚¤: Name

  - ê°’: lab-edu-ec2-web

    ![alt text](./img/code_deploy_deploy_group_02.png)

  - ê¸°ë³¸ ìŠ¤ì¼€ì¤„ëŸ¬ ê°’ : 1ì¼

    ![alt text](./img/code_deploy_deploy_group_03.png)

  - `ë¡œë“œ ë°¸ëŸ°ì‹± í™œì„±í™”` ì²´í¬ í•´ì œ â†’ `ë°°í¬ ê·¸ë£¹ ìƒì„±` ë²„íŠ¼ í´ë¦­

    ![alt text](./img/code_deploy_deploy_group_04.png)

<br>




## CodeDeploy Agent ì„¤ì •

### 1. CodeDeploy Agent ì„¤ì¹˜

- VS Code IDE Terminal ì ‘ì† â†’ SSH ëª…ë ¹ì–´ ì‹¤í–‰

    ```bash
    ssh web-server
    ```

- ê´€ë ¨ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ

    ```bash
    sudo yum update -y && sudo yum install ruby -y && sudo yum install wget -y
    ```

- CodeDeploy Agent ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ë‹¤ìš´ë¡œë“œ

    ```bash
    wget https://aws-codedeploy-ap-northeast-2.s3.ap-northeast-2.amazonaws.com/latest/install
    ```

- ì„¤ì¹˜ íŒŒì¼ ì‹¤í–‰ ê¶Œí•œ í• ë‹¹

    ```bash
    chmod +x ./install
    ```

- ì„¤ì¹˜ íŒŒì¼ ì´ìš© ìµœì‹  ë²„ì „ ì„¤ì¹˜ 

    ```bash
    sudo ./install auto
    ```

- CodeDeploy Agent ì„œë¹„ìŠ¤ ì‹¤í–‰ ë° ìƒíƒœ í™•ì¸ ëª…ë ¹

    ```bash
    systemctl status codedeploy-agent   # sudo service codedeploy-agent status
    systemctl start codedeploy-agent    # sudo service codedeploy-agent start
    ```

<br>




## GitHub Actions ì„¤ì •

### 1. GitHub Actions ì½”ë“œ êµ¬ì„±

- VS Code IDE ì ‘ì†

- `New Folder` ë²„íŠ¼ í´ë¦­

  ![alt text](./img/github_actions_01.png)

- í´ë”ëª… ì…ë ¥: .github/workflows

  ![alt text](./img/github_actions_02.png)

- `.github` í´ë¦­ â†’ `workflows` í´ë¦­ â†’ `New Files` í´ë¦­ â†’ íŒŒì¼ëª… ì…ë ¥: streamlit.yml

  ![alt text](./img/github_actions_03.png)

- `streamlit.yml` íŒŒì¼ì— CI Code ì…ë ¥

  ```yaml
  name: Streamlit CI

  on:
    push:
      branches: [ "main" ]

  env:
    AWS_REGION: ap-northeast-2

  jobs:
    build-and-test:
      runs-on: ubuntu-latest
      strategy:
        max-parallel: 4
        matrix:
          python-version: [3.11]
      steps:
      - uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Test with pytest
        run: |
          pip install pytest
          pytest --collect-only || true

    core-realese:
      needs: build-and-test
      runs-on: ubuntu-latest
      steps:
        # Step 1
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v3
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
            aws-region: ${{ env.AWS_REGION }}

        # Step 2
        - name: Create CodeDeploy Deployment
          id: deploy
          run: |
            aws deploy create-deployment \
              --application-name lab-edu-cd-application-streamlit \
              --deployment-group-name lab-edu-cd-deploygroup \
              --deployment-config-name CodeDeployDefault.OneAtATime \
              --github-location repository=${{ github.repository }},commitId=${{ github.sha }}
  ```

### 2. GitHub Actions YAML Code 

- VS Code IDE Terminal ì ‘ì†

- GitHubë¡œ GitHub Actions YAML Code ë°°í¬

  ```bash
  git add .
  git commit -m "create github actions yaml code"
  git push
  ```

- ê°œì¸ GitHub Repository ì ‘ì† â†’ `Actions` íƒ­ â†’ `create github actions yaml code` ì„ íƒ

  ![alt text](./img/github_actions_04.png)

- `build-and-test`, `core-realese` Jobì˜ Success í™•ì¸

  ![alt text](./img/github_actions_05.png)

- **CodeDeploy ì½˜ì†” ë©”ì¸ í™”ë©´ â†’ `ë°°í¬` íƒ­ â†’ ë°°í¬ ë‚´ì—­ì— ìƒíƒœ ê°’ì´ `ì„±ê³µ`ìœ¼ë¡œ ë°˜ì˜ ë˜ì—ˆëŠ”ì§€ í™•ì¸**

  ![alt text](./img/github_actions_06.png)

- VS Code IDE Terminal ì ‘ì† â†’ SSH ëª…ë ¹ì–´ ì‹¤í–‰

  > ğŸ’¡ ì„œë²„ì— ì½”ë“œ ë°°í¬ê°€ ì˜ ì§„í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ ì ‘ì† í›„ CodeDeploy Agent ë¡œê·¸ë¥¼ í™•ì¸í•œë‹¤.

  ```bash
  ssh web-server
  ```

- ë¡œê·¸ íŒŒì¼ í™•ì¸ `/opt/codedeploy-agent/deployment-root/deployment-logs/codedeploy-agent-deployments.log`

  > ğŸ’¡ AWS Consoleì—ì„œ CodeDeploy ë°°í¬ íƒ­ì—ì„œ í™•ì¸í•œ `ë°°í¬ ID`ì™€ ì•„ë˜ì˜ ë¡œê·¸ íŒŒì¼ì— í™•ì¸ë˜ëŠ” `ë°°í¬ ID`ë¥¼ í™•ì¸í•´ì„œ ì‹¤ì œë¡œ start scriptê°€ ì‹¤í–‰ ëìŒì„ í™•ì¸í•œë‹¤.

  ```bash
  vim /opt/codedeploy-agent/deployment-root/deployment-logs/codedeploy-agent-deployments.log
  ```

  ![alt text](./img/github_actions_07.png)