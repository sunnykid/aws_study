## Table of Contents
- [Table of Contents](#table-of-contents)
- [S3 ë²„í‚·ìš© VPC Endpoint ìƒì„± (Gateway Type)](#s3-ë²„í‚·ìš©-vpc-endpoint-ìƒì„±-gateway-type)
  - [1. Web Server S3 ì ‘ê·¼ í…ŒìŠ¤íŠ¸](#1-web-server-s3-ì ‘ê·¼-í…ŒìŠ¤íŠ¸)
    - [1.1 Web Server ì ‘ì†](#11-web-server-ì ‘ì†)
    - [1.2 S3 Bucket ì ‘ê·¼ ì„¤ì •](#12-s3-bucket-ì ‘ê·¼-ì„¤ì •)
    - [1.3 S3 Bucket ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ](#13-s3-bucket-ê°ì²´-ë¦¬ìŠ¤íŠ¸-ì¡°íšŒ)
  - [2. S3 Bucket Endpoint ìƒì„±](#2-s3-bucket-endpoint-ìƒì„±)
- [S3 Bucket Policy ìˆ˜ì •](#s3-bucket-policy-ìˆ˜ì •)
  - [1. Bucket Policy ì„¤ì •](#1-bucket-policy-ì„¤ì •)
  - [2. Bucket ì ‘ê·¼ ì œí•œ í™•ì¸](#2-bucket-ì ‘ê·¼-ì œí•œ-í™•ì¸)
    - [2.1 VS Code ì„œë²„ì™€ Web ì„œë²„ì˜ S3 ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸](#21-vs-code-ì„œë²„ì™€-web-ì„œë²„ì˜-s3-ì ‘ê·¼-ê¶Œí•œì´-ìˆëŠ”ì§€-í™•ì¸)
    - [2.2 VS Code ì„œë²„ì—ì„œ S3 ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ í…ŒìŠ¤íŠ¸](#22-vs-code-ì„œë²„ì—ì„œ-s3-ê°ì²´-ë¦¬ìŠ¤íŠ¸-ì¡°íšŒ-í…ŒìŠ¤íŠ¸)
    - [2.3 Web ì„œë²„ì—ì„œ S3 ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ í…ŒìŠ¤íŠ¸](#23-web-ì„œë²„ì—ì„œ-s3-ê°ì²´-ë¦¬ìŠ¤íŠ¸-ì¡°íšŒ-í…ŒìŠ¤íŠ¸)
- [VPC Endpointì—ì„œ ì ‘ê·¼í•˜ëŠ” íŠ¸ë˜í”½ë§Œ í—ˆìš©í•˜ëŠ” S3 Bucket Policy ìƒì„±](#vpc-endpointì—ì„œ-ì ‘ê·¼í•˜ëŠ”-íŠ¸ë˜í”½ë§Œ-í—ˆìš©í•˜ëŠ”-s3-bucket-policy-ìƒì„±)
  - [1. Bucket Policy ìƒì„±](#1-bucket-policy-ìƒì„±)
  - [2. VPC Endpoint í†µì‹  ì„¤ì •](#2-vpc-endpoint-í†µì‹ -ì„¤ì •)
  - [3. Bucket ì ‘ê·¼ ì œí•œ í™•ì¸](#3-bucket-ì ‘ê·¼-ì œí•œ-í™•ì¸)
    - [3.1 VS Code ì„œë²„ì—ì„œ S3 ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ í…ŒìŠ¤íŠ¸](#31-vs-code-ì„œë²„ì—ì„œ-s3-ê°ì²´-ë¦¬ìŠ¤íŠ¸-ì¡°íšŒ-í…ŒìŠ¤íŠ¸)
    - [3.2 Web ì„œë²„ì—ì„œ S3 ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ í…ŒìŠ¤íŠ¸](#32-web-ì„œë²„ì—ì„œ-s3-ê°ì²´-ë¦¬ìŠ¤íŠ¸-ì¡°íšŒ-í…ŒìŠ¤íŠ¸)

## S3 ë²„í‚·ìš© VPC Endpoint ìƒì„± (Gateway Type)

### 1. Web Server S3 ì ‘ê·¼ í…ŒìŠ¤íŠ¸

#### 1.1 Web Server ì ‘ì†

- VS Code IDE Terminal ì ‘ì† â†’ SSH ëª…ë ¹ì–´ ì‹¤í–‰

    ```bash
    ssh web-server
    ```

#### 1.2 S3 Bucket ì ‘ê·¼ ì„¤ì •

- `ACCOUNT_ID` ê°’ì„ ë³€ìˆ˜ì— í• ë‹¹

  ```bash
  ACCOUNT_ID=$(aws sts get-caller-identity | jq -r .Account)
  ```

- ë²„í‚· ì´ë¦„ì„ `BUCKET_NAME` ë³€ìˆ˜ì— í• ë‹¹

  ```bash
  BUCKET_NAME="lab-edu-bucket-image-$ACCOUNT_ID"
  ```

#### 1.3 S3 Bucket ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ

```bash
$ aws s3 ls "s3://$BUCKET_NAME"
2024-12-16 05:26:33      47921 cocker_spaniel.jpg
2024-12-16 05:26:33      64638 corgi.jpg
2024-12-16 05:26:33      74181 german_shepherd.jpg
2024-12-16 05:26:33      88081 golden_retriever.jpg
2024-12-16 05:26:33      41784 husky.jpg
2024-12-16 05:26:33      33828 jack_russell_terrier.jpg
2024-12-16 05:26:33      44155 jack_terrier.jpg
2024-12-16 05:26:33      65919 pug.jpg
2024-12-16 05:26:33      52571 shiba_inu.jpg
```

### 2. S3 Bucket Endpoint ìƒì„±

- **VPC ì½˜ì†” ë©”ì¸ í™”ë©´ â†’ `ì—”ë“œí¬ì¸íŠ¸` ë¦¬ì†ŒìŠ¤ íƒ­ â†’ `ì—”ë“œí¬ì¸íŠ¸ ìƒì„±` ë²„íŠ¼ í´ë¦­**

- ì—”ë“œí¬ì¸íŠ¸ ìƒì„± ì •ë³´ ì…ë ¥

    - ì´ë¦„: lab-edu-endpoint-s3

    - ì„œë¹„ìŠ¤ ì´ë¦„ ê²€ìƒ‰ ì°½ì— `com.amazonaws.ap-northeast-2.s3` ì…ë ¥

    - `ìœ í˜•` í•„ë“œì˜ ê°’ì´ `Gateway`ì¸ í•­ëª© ì„ íƒ

        ![alt text](./img/endpoint_01.png)

    - VPC: lab-edu-vpc-ap-01

        ![alt text](./img/endpoint_02.png)

    - ì •ì±…: ì „ì²´ ì•¡ì„¸ìŠ¤

    - `ì—”ë“œí¬ì¸íŠ¸ ìƒì„±` ë²„íŠ¼ í´ë¦­

        ![alt text](./img/endpoint_03.png)

## S3 Bucket Policy ìˆ˜ì •

> ğŸ’¡ **Bucket Policyë¥¼ ì„¤ì •í•˜ëŠ” ì´ìœ ** <br>
> - ì•ì—ì„œ ë²„í‚·ì— ì„¤ì • í•œ PolicyëŠ” Nat Gateway IPë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì ‘ê·¼í•˜ëŠ” ê²½ìš° Allow í•˜ë„ë¡ ì„¤ì •í–ˆë‹¤.
> - í•´ë‹¹ ì •ì±…ì„ ìˆ˜ì •í•´ì„œ VPC Endpointë¡œ ì ‘ê·¼í•˜ëŠ” ê²½ìš°ë§Œ Allow í•˜ë„ë¡ ìˆ˜ì •í•´ì„œ ì‹¤ì œë¡œ íŠ¸ë˜í”½ì´ ë‚´ë¶€ íŠ¸ë˜í”½ë§Œ í—ˆìš©í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.

### 1. Bucket Policy ì„¤ì •

- S3 ì½˜ì†” ë©”ì¸ í™”ë©´ â†’ `lab-edu-bucket-image-{ACCOUNT_ID}` ë²„í‚· í´ë¦­ â†’ `ê¶Œí•œ` íƒ­

- `ë²„í‚· ì •ì±…` í•„ë“œì˜ `ì‚­ì œ` ë²„íŠ¼ í´ë¦­

- í™”ë©´ì— íŒì—…ëœ í™•ì¸ ì°½ì— `ì‚­ì œ` í…ìŠ¤íŠ¸ ì…ë ¥ â†’ `ì‚­ì œ` ë²„íŠ¼ í´ë¦­ 

### 2. Bucket ì ‘ê·¼ ì œí•œ í™•ì¸

#### 2.1 VS Code ì„œë²„ì™€ Web ì„œë²„ì˜ S3 ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸

  > ğŸ’¡ **S3 ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ì´ìœ **
  > - VS Code Serverì—ëŠ” S3 ì ‘ê·¼ ê¶Œí•œì´ ì¡´ì¬ìˆê¸° ë•Œë¬¸ì— Bucket Policyì— ì¶”ê°€ ì„¤ì •ì´ ì—†ì–´ë„ ê°ì²´ ì¡°íšŒê°€ ê°€ëŠ¥í•˜ë‹¤.
  > - Web Serverì—ëŠ” S3 ì ‘ê·¼ ê¶Œí•œì´ ì—†ê¸° ë•Œë¬¸ì— Nat Gatewayë¥¼ ì´ìš©í•´ì„œ ì ‘ê·¼í•´ë„ ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒê°€ ë¶ˆê°€ëŠ¥ í•˜ë‹¤.

- VS Code IDE Terminal ì ‘ì†

- Web Serverì— í• ë‹¹ëœ ê¶Œí•œ ëª©ë¡ ì¡°íšŒ

  > ğŸ’¡ Web Serverì—ëŠ” S3 ì ‘ê·¼ ê¶Œí•œì´ ì—†ëŠ” ê²ƒì„ í™•ì¸í•œë‹¤.

  ```bash
  $ aws iam list-attached-role-policies --role-name lab-edu-role-ec2
  {
      "AttachedPolicies": [
          {
              "PolicyName": "AmazonEC2FullAccess",
              "PolicyArn": "arn:aws:iam::aws:policy/AmazonEC2FullAccess"
          },
          {
              "PolicyName": "CloudWatchFullAccess",
              "PolicyArn": "arn:aws:iam::aws:policy/CloudWatchFullAccess"
          }
      ]
  }
  ```

- VS Code Serverì— í• ë‹¹ëœ ê¶Œí•œ ëª©ë¡ ì¡°íšŒ

  > ğŸ’¡ VS Code Serverì—ëŠ” S3 ì ‘ê·¼ ê¶Œí•œì´ ì¡´ì¬í•˜ëŠ” ê²ƒì„ í™•ì¸í•œë‹¤.

  ```bash
  $ aws iam list-attached-role-policies --role-name lab-edu-role-vscode
  {
      "AttachedPolicies": [
          {
              "PolicyName": "AmazonEC2FullAccess",
              "PolicyArn": "arn:aws:iam::aws:policy/AmazonEC2FullAccess"
          },
          {
              "PolicyName": "IAMFullAccess",
              "PolicyArn": "arn:aws:iam::aws:policy/IAMFullAccess"
          },
          {
              "PolicyName": "AmazonVPCFullAccess",
              "PolicyArn": "arn:aws:iam::aws:policy/AmazonVPCFullAccess"
          },
          {
              "PolicyName": "AmazonS3FullAccess",
              "PolicyArn": "arn:aws:iam::aws:policy/AmazonS3FullAccess"
          },
          {
              "PolicyName": "AWSCloudFormationFullAccess",
              "PolicyArn": "arn:aws:iam::aws:policy/AWSCloudFormationFullAccess"
          }
      ]
  }
  ```

#### 2.2 VS Code ì„œë²„ì—ì„œ S3 ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ í…ŒìŠ¤íŠ¸

- VS Code Serverd Terminalë¡œ ì´ë™

- `ACCOUNT_ID` ê°’ì„ ë³€ìˆ˜ì— í• ë‹¹

  ```bash
  ACCOUNT_ID=$(aws sts get-caller-identity | jq -r .Account)
  ```

- ë²„í‚· ì´ë¦„ì„ `BUCKET_NAME` ë³€ìˆ˜ì— í• ë‹¹

  ```bash
  BUCKET_NAME="lab-edu-bucket-image-$ACCOUNT_ID"
  ```

- ë²„í‚· ë‚´ë¶€ ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ

  ```bash
  $ aws s3 ls "s3://$BUCKET_NAME"
  2024-12-16 05:26:33      47921 cocker_spaniel.jpg
  2024-12-16 05:26:33      64638 corgi.jpg
  2024-12-16 05:26:33      74181 german_shepherd.jpg
  2024-12-16 05:26:33      88081 golden_retriever.jpg
  2024-12-16 05:26:33      41784 husky.jpg
  2024-12-16 05:26:33      33828 jack_russell_terrier.jpg
  2024-12-16 05:26:33      44155 jack_terrier.jpg
  2024-12-16 05:26:33      65919 pug.jpg
  2024-12-16 05:26:33      52571 shiba_inu.jpg
  ```

#### 2.3 Web ì„œë²„ì—ì„œ S3 ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ í…ŒìŠ¤íŠ¸

- VS Code Terminalì—ì„œ ssh ëª…ë ¹ì„ í†µí•´ Web Server ì ‘ì†

    ```bash
    $ ssh web-server
    ```

- `ACCOUNT_ID` ê°’ì„ ë³€ìˆ˜ì— í• ë‹¹

  ```bash
  ACCOUNT_ID=$(aws sts get-caller-identity | jq -r .Account)
  ```

- ë²„í‚· ì´ë¦„ì„ `BUCKET_NAME` ë³€ìˆ˜ì— í• ë‹¹

  ```bash
  BUCKET_NAME="lab-edu-bucket-image-$ACCOUNT_ID"
  ```

- ë²„í‚· ë‚´ë¶€ ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ

  ```bash
  $ aws s3 ls "s3://$BUCKET_NAME"
  
  An error occurred (AccessDenied) when calling the ListObjectsV2 operation: User: arn:aws:sts::************:assumed-role/lab-edu-role-ec2/i-009a44f7f7119202e is not authorized to perform: s3:ListBucket on resource: "arn:aws:s3:::lab-edu-bucket-image-************" because no identity-based policy allows the s3:ListBucket action
  ```

## VPC Endpointì—ì„œ ì ‘ê·¼í•˜ëŠ” íŠ¸ë˜í”½ë§Œ í—ˆìš©í•˜ëŠ” S3 Bucket Policy ìƒì„±

> ğŸ’¡ **Bucket Policyë¥¼ ì ìš© í›„ ë°”ë€ŒëŠ” ë¶€ë¶„** <br>
> - ì´ë²ˆ ë‹¨ê³„ì—ì„œëŠ” VPC Endpointë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” Subnetì„ ì§€ì •í•˜ëŠ”ë° Web Serverê°€ ë°°ì¹˜ ë˜ì–´ ìˆëŠ” Private Subnet 01, 02ë²ˆì— ì ìš©í•œë‹¤.
> - Bucket Policyê°€ ì ìš©ë˜ê¸° ì „ì—ëŠ” VS Code Serverì—ì„œë§Œ S3 ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒê°€ ê°€ëŠ¥ í–ˆì§€ë§Œ,
> - VPC Endpointë¡œ ì ‘ê·¼í•˜ëŠ” íŠ¸ë˜í”½ì€ í—ˆìš©í•˜ëŠ” ë²„í‚· ì •ì±…ì„ ì¶”ê°€í•´ Web Serverì—ëŠ” ë²„í‚· ì ‘ê·¼ ê¶Œí•œì´ ì—†ì§€ë§Œ ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒê°€ ê°€ëŠ¥í•´ì§„ë‹¤. 

### 1. Bucket Policy ìƒì„±

- VS Code Terminal ì ‘ì† â†’ Shell Script í´ë”ë¡œ ì´ë™

    ```bash
    cd /Workshop/support_files/policy
    ```

- Bucket Policy ìƒì„± Script ì‹¤í–‰

    ```bash
    sudo sh ./s3_bucket_policy_endpoint.sh
    ```

- ì •ì±… ë°˜ì˜ ëª…ë ¹ì–´ ì‹¤í–‰

    ```bash
    ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
    ```

    ```bash
    BUCKET_NAME="lab-edu-bucket-image-$ACCOUNT_ID"
    ```

    ```bash
    aws s3api put-bucket-policy --bucket $BUCKET_NAME --policy file://s3_bucket_policy_endpoint_output.json
    ```

### 2. VPC Endpoint í†µì‹  ì„¤ì • 

- **VPC ì½˜ì†” ë©”ì¸ í™”ë©´ â†’ `ì—”ë“œí¬ì¸íŠ¸` ë¦¬ì†ŒìŠ¤ íƒ­ â†’ `lab-edu-endpoint-s3` ì„ íƒ â†’ `ì‘ì—…` â†’ `ë¼ìš°íŒ… í…Œì´ë¸” ê´€ë¦¬` ë²„íŠ¼ í´ë¦­**

  ![alt text](./img/endpoint_rtb_setting_01.png)

- `lab-edu-rtb-pri-01`, `lab-edu-rtb-pri-01` ì„ íƒ â†’ `ë¼ìš°íŒ… í…Œì´ë¸” ìˆ˜ì •` ë²„íŠ¼ í´ë¦­

  ![alt text](./img/endpoint_rtb_setting_02.png)

### 3. Bucket ì ‘ê·¼ ì œí•œ í™•ì¸

#### 3.1 VS Code ì„œë²„ì—ì„œ S3 ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ í…ŒìŠ¤íŠ¸

- VS Code Serverd Terminalë¡œ ì´ë™

- `ACCOUNT_ID` ê°’ì„ ë³€ìˆ˜ì— í• ë‹¹

  ```bash
  ACCOUNT_ID=$(aws sts get-caller-identity | jq -r .Account)
  ```

- ë²„í‚· ì´ë¦„ì„ `BUCKET_NAME` ë³€ìˆ˜ì— í• ë‹¹

  ```bash
  BUCKET_NAME="lab-edu-bucket-image-$ACCOUNT_ID"
  ```

- ë²„í‚· ë‚´ë¶€ ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ

  ```bash
  $ aws s3 ls s3://$BUCKET_NAME
  2024-12-16 05:26:33      47921 cocker_spaniel.jpg
  2024-12-16 05:26:33      64638 corgi.jpg
  2024-12-16 05:26:33      74181 german_shepherd.jpg
  2024-12-16 05:26:33      88081 golden_retriever.jpg
  2024-12-16 05:26:33      41784 husky.jpg
  2024-12-16 05:26:33      33828 jack_russell_terrier.jpg
  2024-12-16 05:26:33      44155 jack_terrier.jpg
  2024-12-16 05:26:33      65919 pug.jpg
  2024-12-16 05:26:33      52571 shiba_inu.jpg
  ```

#### 3.2 Web ì„œë²„ì—ì„œ S3 ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ í…ŒìŠ¤íŠ¸

- VS Code Terminalì—ì„œ ssh ëª…ë ¹ì„ í†µí•´ Web Server ì ‘ì†

    ```bash
    $ ssh web-server
    ```

- `ACCOUNT_ID` ê°’ì„ ë³€ìˆ˜ì— í• ë‹¹

  ```bash
  ACCOUNT_ID=$(aws sts get-caller-identity | jq -r .Account)
  ```

- ë²„í‚· ì´ë¦„ì„ `BUCKET_NAME` ë³€ìˆ˜ì— í• ë‹¹

  ```bash
  BUCKET_NAME="lab-edu-bucket-image-$ACCOUNT_ID"
  ```

- ë²„í‚· ë‚´ë¶€ ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ

  ```bash
  $ aws s3 ls s3://$BUCKET_NAME
  2024-12-16 05:26:33      47921 cocker_spaniel.jpg
  2024-12-16 05:26:33      64638 corgi.jpg
  2024-12-16 05:26:33      74181 german_shepherd.jpg
  2024-12-16 05:26:33      88081 golden_retriever.jpg
  2024-12-16 05:26:33      41784 husky.jpg
  2024-12-16 05:26:33      33828 jack_russell_terrier.jpg
  2024-12-16 05:26:33      44155 jack_terrier.jpg
  2024-12-16 05:26:33      65919 pug.jpg
  2024-12-16 05:26:33      52571 shiba_inu.jpg
  ```
